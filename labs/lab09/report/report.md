---
## Front matter
title: "Отчёт по лабораторной работе №9"
subtitle: "Управление SELinux"
author: "Шаханеоядж Хаоладар"

## Generic otions
lang: ru-RU
toc-title: "Содержание"

## Bibliography
bibliography: bib/cite.bib
csl: pandoc/csl/gost-r-7-0-5-2008-numeric.csl

## Pdf output format
toc: true
toc-depth: 2
lof: true
lot: true
fontsize: 12pt
linestretch: 1.5
papersize: a4
documentclass: scrreprt
## I18n polyglossia
polyglossia-lang:
  name: russian
  options:
    - spelling=modern
    - babelshorthands=true
polyglossia-otherlangs:
  name: english
## I18n babel
babel-lang: russian
babel-otherlangs: english
## Fonts
mainfont: IBM Plex Serif
romanfont: IBM Plex Serif
sansfont: IBM Plex Sans
monofont: IBM Plex Mono
mathfont: STIX Two Math
mainfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
romanfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
sansfontoptions: Ligatures=Common,Ligatures=TeX,Scale=MatchLowercase,Scale=0.94
monofontoptions: Scale=MatchLowercase,Scale=0.94,FakeStretch=0.9
mathfontoptions:
## Biblatex
biblatex: true
biblio-style: "gost-numeric"
biblatexoptions:
  - parentracker=true
  - backend=biber
  - hyperref=auto
  - language=auto
  - autolang=other*
  - citestyle=gost-numeric
## Pandoc-crossref LaTeX customization
figureTitle: "Рис."
tableTitle: "Таблица"
listingTitle: "Листинг"
lofTitle: "Список иллюстраций"
lotTitle: "Список таблиц"
lolTitle: "Листинги"
## Misc options
indent: true
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{float}
  - \floatplacement{figure}{H}
---

# Цель работы

Получить навыки работы с контекстом безопасности и политиками SELinux.

# Выполнение

## Управление режимами SELinux

1. Сначала был запущен терминал и получены полномочия администратора с помощью команды **su -**.  
   После этого проверен текущий статус SELinux командой **sestatus -v**.  
   На экране отображены подробные сведения о политике безопасности:  
   - **SELinux status: enabled** — система SELinux включена;  
   - **Loaded policy name: targeted** — используется целевая политика, при которой защита применяется только к определённым процессам;  
   - **Current mode: enforcing** — включён режим принудительного контроля доступа;  
   - **Policy MLS status: enabled** — активирована многоуровневая защита (MLS).  

   ![Вывод команды sestatus -v](Screenshot_1.png){ #fig:001 width=80% }

2. Для уточнения текущего режима работы SELinux введена команда **getenforce**.  
   Вывод **Enforcing** подтверждает, что система работает в режиме строгого применения политик.  

3. Для переключения SELinux в разрешающий режим (Permissive) использовалась команда **setenforce 0**,  
   после чего повторная проверка (**getenforce**) показала состояние **Permissive**.  
   В этом режиме нарушения фиксируются, но не блокируются.  

   ![Переключение режима SELinux в Permissive](Screenshot_2.png){ #fig:002 width=80% }

4. Далее открыт файл конфигурации `/etc/sysconfig/selinux` и параметр **SELINUX** изменён на значение **disabled**,  
   что полностью отключает SELinux после перезагрузки.  

   ![Редактирование файла /etc/sysconfig/selinux — отключение SELinux](Screenshot_3.png){ #fig:003 width=80% }

5. После перезагрузки выполнена проверка состояния SELinux командой **getenforce** — система сообщила, что SELinux **Disabled**.  
   Попытка включить SELinux через **setenforce 1** завершилась сообщением:  
   *«SELinux is disabled»*, что подтверждает невозможность динамического включения без перезагрузки.  

   ![Проверка отключения SELinux](Screenshot_4.png){ #fig:004 width=80% }

6. Затем в том же конфигурационном файле значение **SELINUX** было изменено обратно на **enforcing**.  
   После перезагрузки система выдала предупреждение о необходимости восстановления меток безопасности (relabeling).  

   ![Сообщение о необходимости relabeling при загрузке](Screenshot_5.png){ #fig:005 width=80% }

7. После завершения relabeling и перезапуска команда **sestatus -v** вновь показала,  
   что SELinux включён и работает в режиме **enforcing**.  

   ![Повторная проверка SELinux после relabeling](Screenshot_6.png){ #fig:006 width=80% }

## Использование restorecon для восстановления контекста безопасности

1. Для начала был выполнен переход в режим суперпользователя.  
   Затем проверен контекст безопасности файла `/etc/hosts` командой **ls -Z /etc/hosts** —  
   он имел тип **net_conf_t**, соответствующий сетевым конфигурационным файлам.  

2. Файл `/etc/hosts` был скопирован в домашний каталог (**cp /etc/hosts ~/**).  
   После проверки контекста нового файла (**ls -Z ~/hosts**)  
   видно, что тип контекста изменился на **admin_home_t**, так как копирование создало новый объект.  

3. При перемещении файла обратно в `/etc` (**mv ~/hosts /etc**)  
   контекст остался прежним — **admin_home_t**, что не соответствует назначению файла.  

4. Для восстановления корректного контекста была применена команда **restorecon -v /etc/hosts**,  
   которая изменила тип обратно на **net_conf_t**.  

5. Проверка (**ls -Z /etc/hosts**) подтвердила правильное восстановление контекста.  
   Затем была создана метка **.autorelabel** (**touch /.autorelabel**),  
   чтобы при следующей перезагрузке система выполнила массовое восстановление контекстов безопасности.  

   ![Использование restorecon и подготовка к relabeling](Screenshot_7.png){ #fig:007 width=80% }

6. После перезагрузки отображено сообщение о запуске **SELinux autorelabel**,  
   подтверждающее автоматическое восстановление всех контекстов файловой системы.  

   ![Процесс relabeling SELinux при загрузке](Screenshot_8.png){ #fig:008 width=80% }
   
## Настройка контекста безопасности для нестандартного расположения файлов веб-сервера

1. Был запущен терминал и получены полномочия администратора. Установлены необходимые пакеты httpd и lynx. Затем создан новый каталог `/web`, предназначенный для размещения файлов веб-сервера. Внутри каталога создан файл `index.html` с текстом «Welcome to my web-server».

2. В конфигурационном файле `/etc/httpd/conf/httpd.conf` закомментирована строка, указывающая стандартный корневой каталог `/var/www/html`, и добавлена новая строка `DocumentRoot "/web"`. Также был добавлен раздел, определяющий права доступа к новому каталогу.  

   ![Изменение DocumentRoot и настроек каталога в файле конфигурации Apache](Screenshot_9.png){ #fig:009 width=80% }

3. После запуска службы httpd и включения её автозагрузки при обращении к `http://localhost` через текстовый браузер lynx отобразилась стандартная тестовая страница Rocky Linux. Это означало, что доступ к каталогу `/web` блокируется политикой безопасности SELinux.  

   ![Страница Apache по умолчанию при первом запуске](Screenshot_10.png){ #fig:010 width=80% }

4. Для разрешения доступа веб-сервера к новому каталогу был добавлен контекст безопасности типа `httpd_sys_content_t` и выполнено восстановление контекста. В результате каталог `/web` и файл `index.html` получили корректные метки безопасности, позволяющие Apache считывать их содержимое.  

   ![Применение нового контекста безопасности к каталогу /web](Screenshot_11.png){ #fig:011 width=80% }

5. После обновления контекста безопасности и повторного обращения к веб-серверу страница с сообщением «Welcome to my web server» отобразилась успешно, что подтверждает правильную настройку SELinux для нового расположения веб-контента.  

   ![Отображение пользовательской страницы веб-сервера](Screenshot_12.png){ #fig:012 width=80% }

## Работа с переключателями SELinux

1. После получения прав суперпользователя был просмотрен список переключателей SELinux, связанных со службой FTP. Среди них параметр `ftpd_anon_write` имел состояние `off`, то есть запись для анонимных пользователей была запрещена.

2. С помощью утилиты `semanage` было получено описание переключателя `ftpd_anon_write`, подтверждающее, что он отвечает за разрешение записи для анонимных FTP-пользователей.

3. Переключатель был активирован и временно изменён на состояние `on`, после чего проверка показала, что изменение вступило в силу.

4. Для сохранения этого состояния после перезагрузки переключатель был установлен с постоянным флагом. Теперь оба значения — временное и постоянное — находятся в положении `on`.  

   ![Просмотр и изменение переключателей SELinux для службы FTP](Screenshot_13.png){ #fig:013 width=80% }

   
# Контрольные вопросы

1. Вы хотите временно поставить SELinux в разрешающем режиме. Какую команду вы используете?  
   **setenforce 0** — переводит SELinux в разрешающий режим (Permissive) до следующей перезагрузки системы.

2. Вам нужен список всех доступных переключателей SELinux. Какую команду вы используете?  
   **getsebool -a** — выводит список всех переключателей (boolean) SELinux и их текущее состояние.

3. Каково имя пакета, который требуется установить для получения легко читаемых сообщений журнала SELinux в журнале аудита?  
   **setroubleshoot** — пакет, обеспечивающий удобное отображение сообщений SELinux и рекомендации по устранению ошибок.

4. Какие команды вам нужно выполнить, чтобы применить тип контекста httpd_sys_content_t к каталогу /web?  
   - **semanage fcontext -a -t httpd_sys_content_t "/web(/.*)?"** — добавление нового типа контекста.  
   - **restorecon -R -v /web** — применение контекста к каталогу и его содержимому.

5. Какой файл вам нужно изменить, если вы хотите полностью отключить SELinux?  
   **/etc/sysconfig/selinux** — в этом файле необходимо установить параметр `SELINUX=disabled`.

6. Где SELinux регистрирует все свои сообщения?  
   **/var/log/audit/audit.log** — основной журнал, в котором фиксируются все события SELinux.

7. Вы не знаете, какие типы контекстов доступны для службы ftp. Какая команда позволяет получить более конкретную информацию?  
   **semanage boolean -l | grep ftp** — выводит список переключателей и связанных контекстов для службы FTP с их описанием.

8. Ваш сервис работает не так, как ожидалось, и вы хотите узнать, связано ли это с SELinux или чем-то ещё. Какой самый простой способ узнать?  
   **setenforce 0** — временно перевести SELinux в разрешающий режим.  
   Если после этого служба начнёт работать корректно, проблема связана с политикой SELinux.

# Заключение  

В ходе работы изучены режимы SELinux, методы их переключения и настройка контекстов безопасности. Освоены команды управления политиками, восстановления контекста и работы с переключателями SELinux.
